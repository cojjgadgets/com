<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Account - COJJ Gadgets</title>
  <meta name="description" content="View your order history and account details at COJJ Gadgets">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="icon" href="images/logo.jpg" type="image/png">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="./" class="logo" aria-label="COJJ Gadgets Home">
        <span style="font-weight: 800; font-size: 22px; letter-spacing: 0.8px; color: #fff;">COJJ<img src="images/logo.jpg" alt="COJJ Gadgets Logo" style="height: 16px; width: auto; margin-left: 2px; vertical-align: middle;" /></span>
      </a>
      <div class="nav-search">
        <div class="search-container">
          <button onclick="history.back()" class="go-back-btn" aria-label="Go back to previous page">‚Üê Go Back</button>
        </div>
      </div>
      <nav class="nav">
        <a href="./">Home</a>
        <a href="about.html">About</a>
        <a href="cart.html">Cart (<span id="cartCount">0</span>)</a>
        <a href="contact.html">Contact</a>
        <a href="account.html" class="active">My Account</a>
        <div class="auth-buttons-mobile">
          <button class="btn btn-sm" onclick="showLoginModal()">Login</button>
          <button class="btn btn-sm" onclick="showSignupModal()">Sign Up</button>
        </div>
      </nav>
      <div class="auth-buttons">
        <button class="btn btn-sm" onclick="showLoginModal()">Login</button>
        <button class="btn btn-sm" onclick="showSignupModal()">Sign Up</button>
      </div>
      <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </header>

  <main class="account-page">
    <div class="container">
      <div class="account-header">
        <h1>My Account</h1>
        <p>Manage your orders and account information</p>
        <button class="btn" onclick="refreshAccountPage()" style="margin-top: 10px;">üîÑ Refresh</button>
      </div>

      <!-- Login Required Message -->
      <div id="loginRequired" class="login-required" style="display: none;">
        <div class="login-card">
          <h2>Please Sign In</h2>
          <p>You need to be signed in to view your account and order history.</p>
          <div class="login-actions">
            <button class="btn" onclick="showLoginModal()">Sign In</button>
            <button class="btn" onclick="showSignupModal()">Create Account</button>
          </div>
        </div>
      </div>

      <!-- Account Content -->
      <div id="accountContent" class="account-content" style="display: none;">
        <!-- Profile Section -->
        <section class="profile-section">
          <h2>Profile Information</h2>
          <div class="profile-card">
            <div class="profile-info">
              <h3 id="userName">Loading...</h3>
              <p id="userEmail">Loading...</p>
              <p id="userPhone">Loading...</p>
              <p id="userAddress">Loading...</p>
            </div>
            <button class="btn" onclick="showProfileModal()">Edit Profile</button>
          </div>
        </section>

        <!-- Orders Section -->
        <section class="orders-section">
          <h2>Order History</h2>
          <div id="ordersList" class="orders-list">
            <div class="loading">Loading your orders...</div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div>
        <strong>COJJ Gadgets</strong>
        <p>Admiralty Mall, Lekki Phase 1, Lagos</p>
        <p><a href="tel:+2347036140846" style="text-decoration: none; color: var(--accent-2);">üìû Call us</a> | <a href="https://wa.me/2347036140846" style="text-decoration: none; color: var(--accent-2);">‚úâÔ∏è Write us</a></p>
      </div>
      <div>
        <a href="./" class="btn">Back to Home</a>
      </div>
    </div>
  </footer>

  <!-- Chat Button -->
  <a href="https://wa.me/2347036140846" class="chat-btn" aria-label="Chat with us on WhatsApp">
    üí¨
  </a>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="assets/js/data.js"></script>
  <script src="assets/js/supabase-config.js"></script>
  <script src="assets/js/auth-modals.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    // Account page functionality
    let authInitialized = false;

    document.addEventListener('DOMContentLoaded', async () => {
      // Wait for auth to be initialized
      await waitForAuth();
      await initializeAccountPage();
    });

    async function waitForAuth() {
      let attempts = 0;
      while (attempts < 100) { // Wait up to 10 seconds
        if (typeof isLoggedIn === 'function' && typeof getCurrentUser === 'function') {
          authInitialized = true;
          break;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
    }

    async function initializeAccountPage() {
      if (!authInitialized) {
        console.error('Auth not initialized after waiting');
        showLoginRequired();
        return;
      }

      // Check if user is logged in using both methods
      const isLoggedInCheck = isLoggedIn();
      const currentUserCheck = getCurrentUser();
      
      console.log('Auth check:', { isLoggedInCheck, currentUserCheck, authInitialized });

      // Fallback: check Supabase session directly
      let hasValidSession = false;
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        hasValidSession = !!session;
        console.log('Direct session check:', { hasValidSession, session });
      } catch (error) {
        console.error('Error checking session:', error);
      }

      if (!isLoggedInCheck && !hasValidSession) {
        showLoginRequired();
        return;
      }

      // User is logged in, show account content
      showAccountContent();
      await loadUserProfile();
      await loadUserOrders();
      await subscribeToOrderUpdates();
    }

    function showLoginRequired() {
      document.getElementById('loginRequired').style.display = 'block';
      document.getElementById('accountContent').style.display = 'none';
    }

    function showAccountContent() {
      document.getElementById('loginRequired').style.display = 'none';
      document.getElementById('accountContent').style.display = 'block';
    }

    async function loadUserProfile() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser) {
          console.error('No current user found');
          return;
        }

        // Load profile from database directly
        const { data: userProfile, error } = await supabaseClient
          .from('user_profiles')
          .select('*')
          .eq('user_id', currentUser.id)
          .single();

        if (error) {
          console.error('Error loading user profile:', error);
          // Show user info from auth if profile not found
          document.getElementById('userName').textContent = currentUser.user_metadata?.full_name || currentUser.email || 'Not provided';
          document.getElementById('userEmail').textContent = currentUser.email || 'Not provided';
          document.getElementById('userPhone').textContent = currentUser.user_metadata?.phone || 'Not provided';
          document.getElementById('userAddress').textContent = currentUser.user_metadata?.address || 'Not provided';
          return;
        }

        if (userProfile) {
          document.getElementById('userName').textContent = userProfile.full_name || 'Not provided';
          document.getElementById('userEmail').textContent = userProfile.email || 'Not provided';
          document.getElementById('userPhone').textContent = userProfile.phone || 'Not provided';
          document.getElementById('userAddress').textContent = userProfile.address || 'Not provided';
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
        // Show user info from auth as fallback
        const currentUser = getCurrentUser();
        if (currentUser) {
          document.getElementById('userName').textContent = currentUser.user_metadata?.full_name || currentUser.email || 'Not provided';
          document.getElementById('userEmail').textContent = currentUser.email || 'Not provided';
          document.getElementById('userPhone').textContent = currentUser.user_metadata?.phone || 'Not provided';
          document.getElementById('userAddress').textContent = currentUser.user_metadata?.address || 'Not provided';
        }
      }
    }

    async function loadUserOrders() {
      try {
        const currentUser = getCurrentUser();
        if (!currentUser) {
          console.error('No current user found for orders');
          document.getElementById('ordersList').innerHTML = '<div class="error">User not authenticated. Please sign in again.</div>';
          return;
        }

        console.log('Loading orders for user:', currentUser.id);

        const { data: orders, error } = await supabaseClient
          .from('orders')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        console.log('Orders query result:', { orders, error });

        if (error) {
          console.error('Error loading orders:', error);
          let errorMessage = error.message;
          if (error.code === 'PGRST301') {
            errorMessage = 'No orders found for this user.';
          } else if (error.code === '42501') {
            errorMessage = 'Permission denied. Please check your authentication.';
          } else if (error.message.includes('JSON')) {
            errorMessage = 'Data format error. Please contact support.';
          }
          document.getElementById('ordersList').innerHTML = `<div class="error">Error loading orders: ${errorMessage} Please try again.</div>`;
          return;
        }

        if (!orders || orders.length === 0) {
          document.getElementById('ordersList').innerHTML = '<div class="no-orders">No orders found. <a href="./">Start shopping</a></div>';
          return;
        }

        displayOrders(orders);
      } catch (error) {
        console.error('Error loading orders:', error);
        document.getElementById('ordersList').innerHTML = `<div class="error">Error loading orders: ${error.message}. Please try again.</div>`;
      }
    }

    function displayOrders(orders) {
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = orders.map(order => {
        // Safely parse items JSON
        let items = [];
        try {
          if (typeof order.items === 'string') {
            items = JSON.parse(order.items);
          } else if (Array.isArray(order.items)) {
            items = order.items;
          } else {
            console.warn('Invalid items format for order:', order.id, order.items);
            items = [];
          }
        } catch (error) {
          console.error('Error parsing items for order:', order.id, error);
          items = [];
        }

        return `
          <div class="order-card" data-order-id="${order.id}">
            <div class="order-header">
              <div class="order-info">
                <h3>Order #${order.order_number}</h3>
                <p class="order-date">${new Date(order.created_at).toLocaleDateString()}</p>
              </div>
              <div class="order-status">
                <span class="status-badge" data-field="status">${order.status || 'pending'}</span>
              </div>
            </div>
            
            <div class="order-items">
              <h4>Items Ordered:</h4>
              <div class="items-list">
                ${items.length > 0 ? items.map(item => `
                  <div class="item">
                    <span class="item-name">${item.name || 'Unknown Item'}</span>
                    <span class="item-quantity">x${item.quantity || 1}</span>
                    <span class="item-price">${formatNaira((item.price || 0) * (item.quantity || 1))}</span>
                  </div>
                `).join('') : '<div class="item">No items found</div>'}
              </div>
            </div>
            
            <div class="order-summary">
              <div class="order-details">
                <p><strong>Total:</strong> ${formatNaira(order.total_amount || 0)}</p>
                <p><strong>Delivery:</strong> ${order.fulfillment_method || 'Not specified'}</p>
                <p><strong>Payment:</strong> ${order.payment_method || 'Not specified'}</p>
                ${order.color_preference ? `<p><strong>Color:</strong> ${order.color_preference}</p>` : ''}
                ${order.notes ? `<p class="order-note-line" data-field="note"><strong>Note:</strong> <span class="order-note-text">${order.notes}</span></p>` : ''}
              </div>
              <div class="order-actions">
                <button class="btn btn-danger" onclick="deleteOrder('${order.id}')">Delete Order</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function subscribeToOrderUpdates(){
      try{
        const currentUser = getCurrentUser();
        if(!currentUser) return;
        // Subscribe to realtime updates for this user's orders
        const channel = supabaseClient
          .channel(`orders-user-${currentUser.id}`)
          .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'orders', filter: `user_id=eq.${currentUser.id}` },
            (payload) => {
              const row = payload.new || payload.old;
              if(!row || row.user_id !== currentUser.id) return;
              // Update or re-render the specific order card
              updateOrderCard(row.id, payload.new);
            }
          )
          .subscribe();
      }catch(err){
        console.error('Failed to subscribe to order updates', err);
      }
    }

    function updateOrderCard(orderId, updated){
      if(!updated){
        // If deleted, remove from DOM
        const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
        if(card) card.remove();
        return;
      }
      const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
      if(!card){
        // If not present, reload list
        loadUserOrders();
        return;
      }
      // Status text
      const statusEl = card.querySelector('[data-field="status"]');
      if(statusEl){ statusEl.textContent = updated.status || 'pending'; }
      // Note line
      let noteLine = card.querySelector('[data-field="note"]');
      if(updated.notes){
        if(!noteLine){
          const details = card.querySelector('.order-details');
          if(details){
            const p = document.createElement('p');
            p.className = 'order-note-line';
            p.setAttribute('data-field','note');
            p.innerHTML = `<strong>Note:</strong> <span class="order-note-text"></span>`;
            details.appendChild(p);
            noteLine = p;
          }
        }
        const noteText = noteLine?.querySelector('.order-note-text');
        if(noteText){ noteText.textContent = updated.notes; }
      } else if(noteLine){
        noteLine.remove();
      }
    }

    function getStatusText(status) {
      const statusMap = {
        'pending': 'Order Received',
        'confirmed': 'Confirmed',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
      };
      return statusMap[status] || status;
    }

    async function deleteOrder(orderId) {
      if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('orders')
          .delete()
          .eq('id', orderId)
          .eq('user_id', getCurrentUser().id); // Ensure user can only delete their own orders

        if (error) {
          console.error('Error deleting order:', error);
          alert('Error deleting order. Please try again.');
          return;
        }

        // Remove order from UI
        const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
        if (orderCard) {
          orderCard.remove();
        }

        // Check if no orders left
        const remainingOrders = document.querySelectorAll('.order-card');
        if (remainingOrders.length === 0) {
          document.getElementById('ordersList').innerHTML = '<div class="no-orders">No orders found. <a href="./">Start shopping</a></div>';
        }

        alert('Order deleted successfully.');
      } catch (error) {
        console.error('Error deleting order:', error);
        alert('Error deleting order. Please try again.');
      }
    }

    // Refresh account page
    async function refreshAccountPage() {
      console.log('Refreshing account page...');
      authInitialized = false;
      await waitForAuth();
      await initializeAccountPage();
    }

    // Make functions global
    window.deleteOrder = deleteOrder;
    window.refreshAccountPage = refreshAccountPage;
  </script>
</body>
</html>
